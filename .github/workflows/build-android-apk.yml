name: Build Android APK

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
    - name: Setup Gradle 8.8
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.8'
      - name: Install Cordova CLI
        run: |
          npm install -g cordova@12.0.0
          cordova --version

      - name: Create Cordova project structure
        run: |
          cd cordova-todo
          if [ ! -d "todo-cordova" ]; then
            echo "Creating Cordova project..."
            cordova create todo-cordova com.dramaweaver.app 剧情织造机
          fi

      - name: Copy www files
        run: |
          mkdir -p cordova-todo/todo-cordova/www
          cp -r cordova-todo/www/* cordova-todo/todo-cordova/www/
          echo "Copied www files"

      - name: Copy config.xml
        run: |
          cp cordova-todo/config-cordova.xml cordova-todo/todo-cordova/config.xml
          echo "Copied config.xml"

      - name: Add Android platform
        run: |
          cd cordova-todo/todo-cordova
          cordova platform add android@12.0.1 || cordova platform add android

      - name: Build Android APK
        run: |
          cd cordova-todo/todo-cordova
          cordova build android --release
          echo "APK build completed"
          ls -lh platforms/android/app/build/outputs/apk/release/

      - name: Sign APK
        if: env.KEYSTORE_BASE64 != ''
        run: |
          cd cordova-todo/todo-cordova
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > release.keystore
          jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 \
            -keystore release.keystore \
            -storepass "${{ secrets.KEYSTORE_PASSWORD }}" \
            -keypass "${{ secrets.KEY_PASSWORD }}" \
            platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk \
            "${{ secrets.KEY_ALIAS }}"
          ${ANDROID_HOME}/build-tools/34.0.0/zipalign -v 4 \
            platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk \
            platforms/android/app/build/outputs/apk/release/app-release.apk

      - name: Rename APK
        run: |
          cd cordova-todo/todo-cordova
          VERSION=$(grep version config.xml | head -1 | sed 's/.*version="\([^"]*\)".*/\1/')
          BUILD_DATE=$(date +%Y%m%d-%H%M%S)
          if [ -f "platforms/android/app/build/outputs/apk/release/app-release.apk" ]; then
              APK_FILE="platforms/android/app/build/outputs/apk/release/app-release.apk"
          else
              APK_FILE="platforms/android/app/build/outputs/apk/release/app-release-unsigned.apk"
          fi
          cp "$APK_FILE" "dramaweaver-${VERSION}-${BUILD_DATE}.apk"
          echo "APK renamed to: dramaweaver-${VERSION}-${BUILD_DATE}.apk"

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dramaweaver-android-apk
          path: cordova-todo/todo-cordova/dramaweaver-*.apk
          retention-days: 30

      - name: Create Release Summary
        if: success()
        run: |
          echo "# Android APK Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build Information:" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Cordova Version**: $(cordova --version)" >> $GITHUB_STEP_SUMMARY
          echo "- **Node.js Version**: $(node --version)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "APK file has been uploaded to Artifacts." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Download Instructions" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to GitHub Actions page" >> $GITHUB_STEP_SUMMARY
          echo "2. Select this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "3. Download APK from Artifacts section" >> $GITHUB_STEP_SUMMARY
